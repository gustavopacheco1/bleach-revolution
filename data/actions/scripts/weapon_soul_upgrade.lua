local weapons = {
	["Zangetsu"] = { max_souls = 400, upgrade_to = 16340 },
	["Zangetsu"] = { max_souls = 1000, upgrade_to = 16341 },
	["Zangetsu"] = { max_souls = 2600, upgrade_to = 16342 },
	["Zangetsu"] = { max_souls = 5000, upgrade_to = 16343 },
	["Zangetsu"] = { max_souls = 12000, upgrade_to = 16344 },
	
	["Sode no Shirayuki"] = { max_souls = 400, upgrade_to = 16346 },
	["Sode no Shirayuki"] = { max_souls = 1000, upgrade_to = 16347 },
	["Sode no Shirayuki"] = { max_souls = 2600, upgrade_to = 16348 },
	["Sode no Shirayuki"] = { max_souls = 5000, upgrade_to = 16349 },
	["Sode no Shirayuki"] = { max_souls = 12000, upgrade_to = 16350 },
	
	["Zabimaru"] = { max_souls = 400, upgrade_to = 16352 },
	["Zabimaru"] = { max_souls = 1000, upgrade_to = 16353 },
	["Zabimaru"] = { max_souls = 2600, upgrade_to = 16354 },
	["Zabimaru"] = { max_souls = 5000, upgrade_to = 16355 },
	["Zabimaru"] = { max_souls = 12000, upgrade_to = 16356 },
	
	["Hyourinmaru"] = { max_souls = 400, upgrade_to = 16401 },
	["Hyourinmaru"] = { max_souls = 1000, upgrade_to = 16408 },
	["Hyourinmaru"] = { max_souls = 2600, upgrade_to = 16414 },
	["Hyourinmaru"] = { max_souls = 5000, upgrade_to = 16420 },
	["Hyourinmaru"] = { max_souls = 12000, upgrade_to = 16424 },
	
	["Gamuza"] = { max_souls = 400, upgrade_to = 16402 },
	["Gamuza"] = { max_souls = 1000, upgrade_to = 16406 },
	["Gamuza"] = { max_souls = 2600, upgrade_to = 16413 },
	["Gamuza"] = { max_souls = 5000, upgrade_to = 16419 },
	["Gamuza"] = { max_souls = 12000, upgrade_to = 16426 },
	
	["Pantera"] = { max_souls = 400, upgrade_to = 16399 },
	["Pantera"] = { max_souls = 1000, upgrade_to = 16410 },
	["Pantera"] = { max_souls = 2600, upgrade_to = 16416 },
	["Pantera"] = { max_souls = 5000, upgrade_to = 16421 },
	["Pantera"] = { max_souls = 12000, upgrade_to = 16425 },
	
	["Minazuki"] = { max_souls = 400, upgrade_to = 16400 },
	["Minazuki"] = { max_souls = 1000, upgrade_to = 16409 },
	["Minazuki"] = { max_souls = 2600, upgrade_to = 16415 },
	["Minazuki"] = { max_souls = 5000, upgrade_to = 16422 },
	["Minazuki"] = { max_souls = 12000, upgrade_to = 16423 },
	
	["Nozarashi"] = { max_souls = 400, upgrade_to = 16358 },
	["Nozarashi"] = { max_souls = 1000, upgrade_to = 16359 },
	["Nozarashi"] = { max_souls = 2600, upgrade_to = 16360 },
	["Nozarashi"] = { max_souls = 5000, upgrade_to = 16361 },
	["Nozarashi"] = { max_souls = 12000, upgrade_to = 16362 },
	
	["Benihime"] = { max_souls = 400, upgrade_to = 16364 },
	["Benihime"] = { max_souls = 1000, upgrade_to = 16365 },
	["Benihime"] = { max_souls = 2600, upgrade_to = 16366 },
	["Benihime"] = { max_souls = 5000, upgrade_to = 16367 },
	["Benihime"] = { max_souls = 12000, upgrade_to = 16368 },
	
	["Houzukimaru"] = { max_souls = 400, upgrade_to = 16370 },
	["Houzukimaru"] = { max_souls = 1000, upgrade_to = 16371 },
	["Houzukimaru"] = { max_souls = 2600, upgrade_to = 16372 },
	["Houzukimaru"] = { max_souls = 5000, upgrade_to = 16373 },
	["Houzukimaru"] = { max_souls = 12000, upgrade_to = 16374 },
	
	["Senbonzakura"] = { max_souls = 400, upgrade_to = 16430 },
	["Senbonzakura"] = { max_souls = 1000, upgrade_to = 16431 },
	["Senbonzakura"] = { max_souls = 2600, upgrade_to = 16432 },
	["Senbonzakura"] = { max_souls = 5000, upgrade_to = 16433 },
	["Senbonzakura"] = { max_souls = 12000, upgrade_to = 16434 },
	
	["Santa Teresa"] = { max_souls = 400, upgrade_to = 16403 },
	["Santa Teresa"] = { max_souls = 1000, upgrade_to = 16407 },
	["Santa Teresa"] = { max_souls = 2600, upgrade_to = 16412 },
	["Santa Teresa"] = { max_souls = 5000, upgrade_to = 16418 },
	["Santa Teresa"] = { max_souls = 12000, upgrade_to = 16427 },
	
	
	["Brazo Derecha de Gigante"] = { max_souls = 400, upgrade_to = 16376 },
	["Brazo Derecha de Gigante"] = { max_souls = 1000, upgrade_to = 16377 },
	["Brazo Derecha de Gigante"] = { max_souls = 2600, upgrade_to = 16378 },
	["Brazo Derecha de Gigante"] = { max_souls = 5000, upgrade_to = 16379 },
	["Brazo Derecha de Gigante"] = { max_souls = 12000, upgrade_to = 16380 },
	
	
	["Kojaku"] = { max_souls = 400, upgrade_to = 16382 },
	["Kojaku"] = { max_souls = 1000, upgrade_to = 16383 },
	["Kojaku"] = { max_souls = 2600, upgrade_to = 16384 },
	["Kojaku"] = { max_souls = 5000, upgrade_to = 16385 },
	["Kojaku"] = { max_souls = 12000, upgrade_to = 16386 },
	
	["Shun Shun Rikka"] = { max_souls = 400, upgrade_to = 16388 },
	["Shun Shun Rikka"] = { max_souls = 1000, upgrade_to = 16389 },
	["Shun Shun Rikka"] = { max_souls = 2600, upgrade_to = 16390 },
	["Shun Shun Rikka"] = { max_souls = 5000, upgrade_to = 16391 },
	["Shun Shun Rikka"] = { max_souls = 12000, upgrade_to = 16392 },
	
	["Heiling Bogen"] = { max_souls = 400, upgrade_to = 16404 },
	["Heiling Bogen"] = { max_souls = 1000, upgrade_to = 16405 },
	["Heiling Bogen"] = { max_souls = 2600, upgrade_to = 16411 },
	["Heiling Bogen"] = { max_souls = 5000, upgrade_to = 16417 },
	["Heiling Bogen"] = { max_souls = 12000, upgrade_to = 16428 },
	
	["Lanza Del Relampago"] = { max_souls = 400, upgrade_to = 16394 },
	["Lanza Del Relampago"] = { max_souls = 1000, upgrade_to = 16395 },
	["Lanza Del Relampago"] = { max_souls = 2600, upgrade_to = 16396 },
	["Lanza Del Relampago"] = { max_souls = 5000, upgrade_to = 16397 },
	["Lanza Del Relampago"] = { max_souls = 12000, upgrade_to = 16398 }
}

local upgrade_items_id = {
	[10624] = { soul_upgrade = 20 },
	[10625] = { soul_upgrade = 30 },
	[10626] = { soul_upgrade = 40 },
	[10627] = { soul_upgrade = 50 }
}

function onUse(cid, item, fromPosition, itemEx, toPosition)
	if upgrade_items_id[item.itemid] then
		if not weapons[getItemInfo(itemEx.itemid).name] then return end

		-- We need to set item attribute by function for using getItemAttribute
		if getItemAttribute(itemEx.uid, "description") == nil then
			doItemSetAttribute(itemEx.uid, "description", "Soul: 0")
		end

		local weapon = weapons[getItemInfo(itemEx.itemid).name]
		local weapon_soul_amount = tonumber(string.explode(getItemAttribute(itemEx.uid, "description"), " ")[2])

		if weapon_soul_amount >= weapon.max_souls then
			MultiLanguage.doPlayerSendCancel(
				cid,
				"This weapon has already reached its maximum capacity of souls.",
				"Esta arma já alcançou sua capacidade máxima de souls."
			)
			return true
		end

		if (weapon_soul_amount + upgrade_items_id[item.itemid].soul_upgrade) > weapon.max_souls then
			doItemSetAttribute(itemEx.uid, "description", "Soul: " .. tostring(weapon.max_souls))
		else
			doItemSetAttribute(itemEx.uid, "description",
				"Soul: " .. tostring(weapon_soul_amount + upgrade_items_id[item.itemid].soul_upgrade))
		end

		doSendMagicEffect(fromPosition, 13)
		doRemoveItem(item.uid, 1)
		return true
	end

	if weapons[getItemInfo(item.itemid).name] then
		-- ItemEx must have actionid 30000
		if not (getItemAttribute(itemEx.uid, "uid") == 30000) then return end

		-- We need to set item attribute by function for using getItemAttribute
		if getItemAttribute(item.uid, "description") == nil then return end

		local weapon = weapons[getItemInfo(item.itemid).name]
		local weapon_soul_amount = tonumber(string.explode(getItemAttribute(item.uid, "description"), " ")[2])

		if weapon_soul_amount < weapon.max_souls then
			return MultiLanguage.doPlayerSendCancel(
				cid,
				"This weapon needs to reach " .. weapon.max_souls .. " souls to be upgraded.",
				"Esta arma precisa atingir " .. weapon.max_souls .. " souls para ser melhorada."
			)
		end

		doSendMagicEffect({
			x = toPosition.x + 2,
			y = toPosition.y + 1,
			z = toPosition.z
		}, 600)

		doTransformItem(item.uid, weapon.upgrade_to)
		if weapons[getItemInfo(weapon.upgrade_to).name] then
			doItemSetAttribute(item.uid, "description", "Soul: 0")
		else
			doItemSetAttribute(item.uid, "description", "")
		end
	end
	return true
end
